
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App Mockup V21 - Data Sync Fix (Export/Import Users)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* === CSS –°–¢–ò–õ–ò (V21) === */
        :root {
            /* –û–±—â–∏–µ —Ü–≤–µ—Ç–∞ */
            --color-brand: #507198; /* –û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç (–°–∏–Ω–∏–π/–¢–µ–ª–µ–≥—Ä–∞–º) */
            --color-accent: #34c759; /* –ó–µ–ª–µ–Ω—ã–π –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ */
            --color-warning: #f39c12; /* –ñ–µ–ª—Ç—ã–π –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π/–ê–¥–º–∏–Ω–∞ */
            --color-verified: #3498db; /* –°–∏–Ω–∏–π –¥–ª—è –≥–∞–ª–æ—á–∫–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ */
            --color-error: #e74c3c; /* –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –æ—à–∏–±–æ–∫/–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ */

            /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ (Dark Mode) */
            --bg-body: #17212b; /* –§–æ–Ω –≤—Å–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
            --bg-app: #17212b; /* –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–Ω –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
            --bg-sidebar: #0e1621; /* –§–æ–Ω –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ (—Ç–µ–º–Ω–µ–µ) */
            --bg-header: #17212b; /* –§–æ–Ω –∑–∞–≥–æ–ª–æ–≤–∫–∞ —á–∞—Ç–∞ */
            --bg-input: #212e3a; /* –§–æ–Ω –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
            --text-primary: #e6e6e6; /* –û—Å–Ω–æ–≤–Ω–æ–π —Å–≤–µ—Ç–ª—ã–π —Ç–µ–∫—Å—Ç */
            --text-secondary: #a0a0a0; /* –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π —Å–µ—Ä—ã–π —Ç–µ–∫—Å—Ç */
            --border-light: #313f4c; /* –õ–µ–≥–∫–∏–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ */
            --bubble-sent: #507198; /* –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–¶–≤–µ—Ç –±—Ä–µ–Ω–¥–∞) */
            --bubble-received: #212e3a; /* –ü–æ–ª—É—á–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ */
            --sidebar-width: 320px;
        }

        /* --- –û–ë–©–ò–ï –°–¢–ò–õ–ò --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center; 
            overflow: hidden; 
        }

        .container {
            width: 90%;
            max-width: 1400px; 
            height: 90vh; 
            max-height: 1000px;
            display: flex;
            background-color: var(--bg-app);
            border-radius: 12px; 
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.4); 
            overflow: hidden;
        }

        /* --- –ü–õ–ê–í–ù–û–°–¢–¨ --- */
        .chat-item, button, input, .menu-item, .avatar {
            transition: all 0.2s ease-in-out; 
        }

        .hidden { display: none !important; }

        /* --- –ö–Ω–æ–ø–∫–∏ –∏ –ò–Ω–ø—É—Ç—ã --- */
        button {
            border: none;
            cursor: pointer;
            font-weight: 500;
            padding: 10px 20px;
            border-radius: 20px;
            background-color: var(--color-brand);
            color: white;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #405c7d;
        }
        
        input, textarea {
            width: 100%;
            padding: 12px 20px;
            margin-bottom: 15px;
            border: 2px solid transparent; 
            border-radius: 20px;
            background-color: var(--bg-input);
            color: var(--text-primary);
            outline: none;
            resize: none; 
        }
        input:focus, textarea:focus {
            border-color: var(--color-brand); 
            box-shadow: 0 0 0 1px var(--color-brand);
        }

        /* --- –û–±—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã UI --- */
        .auth-container, .permission-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .auth-card, .modal-content {
            background-color: var(--bg-sidebar); 
            padding: 40px;
            border-radius: 15px;
            width: 350px;
            max-height: 90vh;
            overflow-y: auto;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            width: auto;
            min-width: 350px;
        }
        
        .error-message {
            color: var(--color-error);
            margin-bottom: 15px;
            font-size: 0.9em;
            text-align: center;
        }
        
        .switch-link {
            display: block;
            margin-top: 15px;
            color: var(--text-secondary); 
            cursor: pointer;
            font-size: 0.9em;
        }
        .switch-link:hover { color: var(--color-brand); }


        /* --- Sidebar & Chats (—Å—Ç–∏–ª–∏ –Ω–µ –º–µ–Ω—è–ª–∏—Å—å) --- */
        .chats-sidebar {
            width: var(--sidebar-width);
            min-width: var(--sidebar-width);
            border-right: 1px solid var(--border-light);
            background-color: var(--bg-sidebar);
            display: flex;
            flex-direction: column;
            padding-top: 5px; 
        }
        
        .sidebar-header {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-item {
            padding: 12px 15px; 
            display: flex;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid var(--border-light);
        }
        
        .chat-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .chat-item.active {
            background-color: var(--bg-input); 
        }

        .chat-item .info {
             flex-grow: 1;
             margin-left: 10px;
        }

        .chat-item .info .name { 
            display: flex;
            align-items: center;
            font-weight: 500; 
            font-size: 1rem; 
        }
        
        /* --- Chat Window (—Å—Ç–∏–ª–∏ –Ω–µ –º–µ–Ω—è–ª–∏—Å—å) --- */
        .chat-window {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        #chat-view {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            height: 100%;
        }

        .chat-header { 
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px; 
            border-bottom: 1px solid var(--border-light);
            background-color: var(--bg-header);
        }

        .chat-header .info-group {
            display: flex;
            align-items: center;
        }

        .chat-header .name-status {
            margin-left: 10px;
        }
        
        .chat-header .name-status .name { 
            display: flex;
            align-items: center;
            font-weight: 600; 
            font-size: 1.05rem; 
        }
        
        .messages-area { 
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            scrollbar-width: thin;
            scrollbar-color: var(--color-brand) var(--bg-app);
        }

        .message-bubble {
            max-width: 60%;
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message-bubble.sent {
            background-color: var(--bubble-sent);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message-bubble.received {
            background-color: var(--bubble-received);
            color: var(--text-primary);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        
        .input-area {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            border-top: 1px solid var(--border-light);
            background-color: var(--bg-header);
        }

        .input-area input {
            flex-grow: 1;
            margin: 0 10px;
            padding: 10px 15px;
            border-radius: 20px;
            margin-bottom: 0;
        }

        .input-area .send-button {
            padding: 10px 15px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- Avatars & Badges (—Å—Ç–∏–ª–∏ –Ω–µ –º–µ–Ω—è–ª–∏—Å—å) --- */
        .avatar, .profile-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--color-brand);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.1em;
            flex-shrink: 0;
        }

        .avatar.chat-avatar { margin-right: 10px; }
        .avatar.profile-avatar-large {
             width: 80px;
             height: 80px;
             font-size: 2em;
             margin: 20px auto;
             cursor: pointer;
        }
        
        .verified-badge { 
            color: var(--color-verified); 
            font-size: 0.8em;
            margin-left: 6px; 
        }

        /* --- Profile & Admin (—Å—Ç–∏–ª–∏ –Ω–µ –º–µ–Ω—è–ª–∏—Å—å) --- */
        .profile-page {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-app);
            overflow-y: auto;
        }

        .profile-header {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-light);
            background-color: var(--bg-header);
        }

        .profile-header h2 {
            margin-left: 20px;
            font-size: 1.2em;
        }

        .back-to-chat-btn {
            background: none;
            color: var(--text-primary);
            padding: 5px 10px;
        }
        
        .profile-content {
            padding: 20px;
        }

        .menu-list {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }

        .menu-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-light);
            border-radius: 8px;
            margin: 5px 0;
        }
        .menu-item i { margin-right: 15px; color: var(--color-brand); }
        .menu-item span { flex-grow: 1; }
        .menu-item:hover { background-color: var(--bg-input); }
        #admin-menu-item { color: var(--color-warning) !important; }
        #admin-menu-item i { color: var(--color-warning) !important; }

        .logout-button {
            width: 100%;
            background-color: var(--color-error);
            margin-top: 30px;
        }
        
        .admin-action-content { 
            padding: 15px; 
            background-color: var(--bg-input); 
            border-radius: 8px;
            margin-top: 15px;
            text-align: left;
        }
        .admin-action-content select, .admin-action-content input {
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            background-color: var(--bg-sidebar);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
        }

        .admin-action-content button {
            border-radius: 10px;
            padding: 8px 15px;
        }
        
        /* --- –ù–û–í–û–ï –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò --- */
        #sync-data-modal .modal-content {
            width: 500px;
        }

        #sync-data-modal textarea {
            min-height: 150px;
            font-size: 0.8em;
            font-family: monospace;
            border-radius: 8px;
        }
        .sync-action-group {
             margin-top: 15px; 
             padding: 10px; 
             border: 1px solid var(--border-light); 
             border-radius: 8px;
        }

        .sync-action-group h4 {
            margin-bottom: 10px;
            color: var(--color-brand);
        }

    </style>
</head>
<body>
    
    <div class="theme-switcher" onclick="toggleTheme()">
        <i class="fas fa-moon"></i>
    </div>

    <div class="auth-container" id="auth-view">
        <div class="auth-card">
            <i class="fas fa-paper-plane" style="font-size: 2rem; color: var(--color-brand); margin-bottom: 15px;"></i>
            <h2 id="auth-title">–°–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞</h2>
            <div class="error-message" id="error-message"></div>
            <form id="auth-form">
                <input type="text" id="auth-name" placeholder="–ò–º—è" required>
                <input type="text" id="auth-username" placeholder="Username (@user)" required pattern="^@[a-zA-Z0-9_]{5,}$" title="Username –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å @ –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 5 —Å–∏–º–≤–æ–ª–æ–≤.">
                <input type="email" id="auth-email" placeholder="Email" required>
                <input type="password" id="auth-password" placeholder="–ü–∞—Ä–æ–ª—å" required>
                <button type="submit" id="auth-submit-btn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            </form>
            <span class="switch-link" onclick="switchAuthMode()">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</span>
        </div>
    </div>

    <div class="container hidden" id="messenger-view">
        
        <aside class="chats-sidebar">
            <div class="sidebar-header">
                <i class="fas fa-bars profile-icon" onclick="showProfile()"></i>
                <div class="search-bar" style="flex-grow: 1; position: relative;">
                    <input type="text" id="search-friend-input" placeholder="–ü–æ–∏—Å–∫ –∏–ª–∏ @username" onkeydown="handleSearchKey(event)" style="padding-left: 40px; margin-bottom: 0;">
                    <i class="fas fa-search" style="position: absolute; left: 15px; top: 12px; color: var(--text-secondary);"></i>
                </div>
            </div>
            
            <div id="chats-list-container" style="overflow-y: auto; flex-grow: 1;">
                </div>
        </aside>

        <main class="chat-window" id="main-content">
            
            <div id="chat-view">
                <header class="chat-header">
                    <div class="info-group">
                        <div class="avatar chat-avatar" id="current-chat-avatar">ü§ñ</div>
                        <div class="name-status">
                            <span class="name" id="current-chat-name">–ù–µ–π—Ä–æ—Å–µ—Ç—å –ü–æ–¥–¥–µ—Ä–∂–∫–∏</span>
                            <span class="status" id="current-chat-status">–û–Ω–ª–∞–π–Ω</span>
                        </div>
                    </div>
                    <div class="action-icons">
                        <i class="fas fa-phone-alt" onclick="alert('–ê—É–¥–∏–æ–∑–≤–æ–Ω–æ–∫...')"></i>
                        <i class="fas fa-video" onclick="alert('–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫...')"></i>
                        <i class="fas fa-ellipsis-v"></i>
                    </div>
                </header>

                <div class="messages-area" id="messages-area">
                    <div class="message-bubble received">–ü—Ä–∏–≤–µ—Ç! –Ø —á–∞—Ç-–±–æ—Ç –Ω–∞ –±–∞–∑–µ –∏–º–∏—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –Ω–µ–π—Ä–æ—Å–µ—Ç–∏. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</div>
                </div>

                <footer class="input-area">
                    <i class="fas fa-paperclip" style="font-size: 1.2em; color: var(--text-secondary); cursor: pointer;"></i>
                    <input type="text" id="message-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." class="message-input" onkeydown="if(event.key === 'Enter') sendMessage()">
                    <button class="send-button" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                </footer>
            </div>
            
            <div id="profile-view" class="profile-page hidden">
                
                <header class="profile-header">
                    <button class="back-to-chat-btn" onclick="showChat(currentChatId)"><i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥</button>
                    <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                </header>

                <div class="profile-content">
                    
                    <div class="profile-avatar profile-avatar-large" id="profile-avatar-display" onclick="toggleEditProfile()">–Ø</div>
                    
                    <div id="edit-profile-area" class="profile-form-group hidden">
                        <form id="profile-form">
                            <input type="text" id="profile-name-input" placeholder="–ò–º—è" required>
                            <input type="text" id="profile-username-input" placeholder="Username (@user)" pattern="^@[a-zA-Z0-9_]{5,}$" required>
                            <input type="text" id="profile-status-input" placeholder="–°—Ç–∞—Ç—É—Å (–Ω–∞–ø—Ä., –û–Ω–ª–∞–π–Ω)">
                            <input type="text" id="profile-photo-input" placeholder="URL —Ñ–æ—Ç–æ –∏–ª–∏ #—Ü–≤–µ—Ç">
                            <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ü—Ä–æ—Ñ–∏–ª—å</button>
                        </form>
                    </div>

                    <ul class="menu-list">
                        <li class="menu-item" onclick="toggleEditProfile()"> <i class="fas fa-user-circle"></i> <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ü—Ä–æ—Ñ–∏–ª—å</span> <i class="fas fa-chevron-right"></i> </li>
                        <li class="menu-item" onclick="alert('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω—ã/–∑–∞–ø—Ä–µ—â–µ–Ω—ã.')"> <i class="fas fa-bell"></i> <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</span> <i class="fas fa-chevron-right"></i> </li>
                         <li class="menu-item" onclick="alert('–§—É–Ω–∫—Ü–∏—è —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è.')"> <i class="fas fa-lock"></i> <span>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ø–∞—Ä–æ–ª—å</span> <i class="fas fa-chevron-right"></i> </li>
                        <li class="menu-item" id="admin-menu-item" onclick="showAdminPanel()" style="display:none;">
                            <i class="fas fa-gavel"></i>
                            <span style="font-weight: 500;">–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</span>
                            <i class="fas fa-chevron-right"></i>
                        </li>
                        <li class="menu-item" onclick="alert('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–µ—Ä—Å–∏–∏: V21 (Data Sync Fix)')"> <i class="fas fa-info-circle"></i> <span>–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</span> <i class="fas fa-chevron-right"></i> </li>
                    </ul>

                    <button class="logout-button" onclick="logout()">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
                    
                </div>
                
            </div>

        </main>
    </div>
    
    <div id="search-modal" class="permission-modal hidden" onclick="if(event.target.id === 'search-modal') hideSearchModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3>–ù–∞–π—Ç–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</h3>
            <input type="text" id="search-user-input" placeholder="–í–≤–µ–¥–∏—Ç–µ @username –∏–ª–∏ Email" onkeydown="if(event.key === 'Enter') performSearch()">
            <button onclick="performSearch()">–ü–æ–∏—Å–∫</button>
            <div id="search-result" style="margin-top: 15px; text-align: left; font-size: 0.9em;"></div>
        </div>
    </div>
    
    <div id="admin-panel-modal" class="permission-modal hidden" onclick="if(event.target.id === 'admin-panel-modal') hideAdminPanel()">
        <div class="modal-content" style="width: 450px;" onclick="event.stopPropagation()">
            <h3><i class="fas fa-gavel"></i> –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</h3>
            <p style="color:var(--color-warning); margin-bottom: 10px;">–î–µ–π—Å—Ç–≤–∏—è –Ω–µ–æ–±—Ä–∞—Ç–∏–º—ã. –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã.</p>
            
            <input type="text" id="admin-search-input" placeholder="–ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ @username">
            <button onclick="adminSearchUser()">–ü–æ–∏—Å–∫</button>
            
            <div class="error-message" id="admin-message" style="text-align: center; margin-top: 10px;"></div>

            <div id="admin-user-result" class="admin-action-content hidden">
                 <div class="user-info" style="display: flex; align-items: center; padding: 10px; margin-bottom: 15px;">
                    <div id="admin-target-avatar" class="avatar" style="margin-right: 10px;">?</div>
                    <div>
                        <div id="admin-target-name" style="font-weight: bold; font-size: 1.1em;"></div>
                        <div id="admin-target-at" style="font-size: 0.9em; color: var(--text-secondary);"></div>
                        <div id="admin-target-status-display" style="font-size: 0.9em; color: var(--color-accent);"></div>
                    </div>
                </div>
                
                <input type="text" id="admin-reason-input" placeholder="–ü—Ä–∏—á–∏–Ω–∞ (–¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏/–∑–∞–º–æ—Ä–æ–∑–∫–∏)" style="margin-top: 5px;">
                
                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                    <div style="display:flex; gap: 10px;">
                        <button style="background-color: #c0392b;" onclick="adminAction('block')">–ë–õ–û–ö–ò–†–û–í–ê–¢–¨</button>
                        <button style="background-color: #e67e22;" onclick="adminAction('freeze')">–ó–ê–ú–û–†–û–ó–ò–¢–¨</button>
                        <button style="background-color: #27ae60; flex-grow: 1;" onclick="adminAction('unfreeze')">–†–ê–ó–ë–õ./–†–ê–ó–ú–û–†.</button>
                    </div>

                    <select id="admin-role-select" style="width: 100%;">
                        <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (user)</option>
                        <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (admin)</option>
                        <option value="moderator">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä (moderator)</option>
                    </select>
                    <button onclick="adminAction('change_role')">–°–º–µ–Ω–∏—Ç—å –†–æ–ª—å</button>

                    <div style="display:flex; gap: 10px;">
                        <button style="background-color: #3498db; flex-grow: 1;" onclick="adminAction('verify')">–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è (Toggle)</button>
                        <button style="background-color: #9b59b6; flex-grow: 1;" onclick="adminAction('reset_password')">–°–±—Ä–æ—Å–∏—Ç—å –ü–∞—Ä–æ–ª—å</button>
                    </div>
                    
                    <button style="background-color: #7f8c8d;" onclick="adminAction('delete')">–£–î–ê–õ–ò–¢–¨ –ê–ö–ö–ê–£–ù–¢</button>
                </div>
            </div>
            
            <button style="background-color: var(--color-warning); margin-top: 20px;" onclick="showDataSyncModal()">
                <i class="fas fa-sync-alt"></i> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ë–∞–∑—ã –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            </button>


            <button style="background-color: var(--text-secondary); margin-top: 10px;" onclick="hideAdminPanel()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="status-alert-modal" class="permission-modal hidden">
        <div class="modal-content">
            <h3 id="status-alert-title" style="color: #c0392b;">–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</h3>
            <p>–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∏–º–µ–µ—Ç —Å—Ç–∞—Ç—É—Å:</p>
            <p style="margin-top: 10px; color: var(--text-secondary); font-style: italic;" id="status-alert-reason"></p>
            <button onclick="handleStatusAlert()">–û–∫</button>
        </div>
    </div>
    
    <div id="sync-data-modal" class="permission-modal hidden" onclick="if(event.target.id === 'sync-data-modal') hideDataSyncModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3><i class="fas fa-upload"></i> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ë–∞–∑—ã –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (V21)</h3>
            <p style="color: var(--text-secondary); margin-bottom: 10px;">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –º–µ–∂–¥—É "–ü–ö" –∏ "–ü–ª–∞–Ω—à–µ—Ç–æ–º".</p>
            
            <div class="sync-action-group">
                <h4>1. –≠–∫—Å–ø–æ—Ä—Ç (–ù–∞ "–ü–ª–∞–Ω—à–µ—Ç–µ")</h4>
                <p style="font-size: 0.9em; margin-bottom: 10px;">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–µ–∫—É—â—É—é –±–∞–∑—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</p>
                <textarea id="export-data-area" readonly placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è JSON-–∫–æ–¥"></textarea>
                <button onclick="exportUserData()" style="background-color: var(--color-brand); width: 100%;">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ë–∞–∑—É –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</button>
            </div>
            
            <div class="sync-action-group">
                <h4>2. –ò–º–ø–æ—Ä—Ç (–ù–∞ "–ü–ö")</h4>
                <p style="font-size: 0.9em; margin-bottom: 10px;">–í—Å—Ç–∞–≤—å—Ç–µ JSON-–∫–æ–¥ –∏–∑ "–ü–ª–∞–Ω—à–µ—Ç–∞" —Å—é–¥–∞:</p>
                <textarea id="import-data-area" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ JSON-–∫–æ–¥ –±–∞–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"></textarea>
                <button onclick="importUserData()" style="background-color: var(--color-accent); width: 100%;">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ë–∞–∑—É –∏ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>
            
            <div class="error-message" id="sync-message" style="margin-top: 15px;"></div>

            <button style="background-color: var(--text-secondary); margin-top: 20px;" onclick="hideDataSyncModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>


    <script>
        // === JAVASCRIPT –õ–û–ì–ò–ö–ê (V21 - Data Sync Fix) ===

        let currentUserId = null;
        let currentUsername = '–Ø';
        let currentUserAt = null; 
        let currentUserPhoto = ''; 
        let currentUserStatus = '–û–Ω–ª–∞–π–Ω';
        let currentUserRole = 'user'; 
        let currentUserIsVerified = false; 
        let currentChatId = 1; 
        let isLoginMode = false; 
        let pollingInterval = null;

        // --- –ö–û–ù–°–¢–ê–ù–¢–´ –ò –•–†–ê–ù–ï–ù–ò–ï ---
        const ADMIN_USER_ID = 99999; 
        let adminTargetUser = null; 

        const USERS_STORAGE_KEY = 'tgCloneUsersV4';
        const AUTH_USER_KEY = 'tgCloneAuthUserV4';
        const CHAT_MESSAGES_PREFIX = 'tgCloneMessages_';
        const FRIENDS_PREFIX = 'tgCloneFriends_';
        const DEFAULT_PASSWORD = 'password123'; 
        const BOT_CHAT_ID = 1;

        const fakeUsers = [
             { name: "–ê–Ω–Ω–∞", at: "@anna_dev", id: 1000, photo: '#FF7F50', status: '–û–Ω–ª–∞–π–Ω', role: 'user', isVerified: false },
             { name: "–ü–µ—Ç—Ä", at: "@peter_coder", id: 1001, photo: '#20B2AA', status: '–ë—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ', role: 'user', isVerified: true },
             { name: "–î–∂–µ–º–∏–Ω–∏", at: "@gemini_ai", id: 1002, photo: 'ü§ñ', status: '–û–Ω–ª–∞–π–Ω', role: 'bot', isVerified: true }
        ];

        let botChatData = {
            [BOT_CHAT_ID]: [
                { sender: 'ü§ñ –ù–µ–π—Ä–æ—Å–µ—Ç—å', text: '–ü—Ä–∏–≤–µ—Ç! –Ø —á–∞—Ç-–±–æ—Ç –Ω–∞ –±–∞–∑–µ –∏–º–∏—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –Ω–µ–π—Ä–æ—Å–µ—Ç–∏. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?' }
            ]
        };
        
        let lastKnownFriendMessages = {}; 
        
        // --- HELPERS ---
        function getAllUsers() {
            const stored = localStorage.getItem(USERS_STORAGE_KEY);
            return stored ? JSON.parse(stored) : [];
        }

        function saveAllUsers(users) {
            localStorage.setItem(USERS_STORAGE_KEY, JSON.stringify(users));
        }

        // --- –ß–ê–¢–´ ---
        function getUserMessages(userId = currentUserId) {
            if (!userId) return {};
            const stored = localStorage.getItem(CHAT_MESSAGES_PREFIX + userId);
            return stored ? JSON.parse(stored) : {};
        }

        function saveUserMessages(data, userId = currentUserId) {
            if (userId) {
                localStorage.setItem(CHAT_MESSAGES_PREFIX + userId, JSON.stringify(data));
            }
        }
        
        // --- –î–†–£–ó–¨–Ø ---
        function getUserFriends() { 
            if (!currentUserId) return [];
            const stored = localStorage.getItem(FRIENDS_PREFIX + currentUserId);
            return stored ? JSON.parse(stored) : [];
        }

        function saveUserFriends(friends) { 
            if (currentUserId) {
                localStorage.setItem(FRIENDS_PREFIX + currentUserId, JSON.stringify(friends)); 
            }
        }
        
        function getFriendData(chatId) {
            if (chatId === BOT_CHAT_ID) {
                return fakeUsers.find(u => u.at === '@gemini_ai');
            }
            const friends = getUserFriends();
            const friendChatData = friends.find(f => f.chatId == chatId);
            
            if (friendChatData) {
                const allUsers = [...fakeUsers, ...getAllUsers()];
                const friendData = allUsers.find(u => u.at === friendChatData.at);
                
                if (friendData) {
                    friendData.chatId = chatId;
                    return friendData;
                }
                return friendChatData;
            }
            return null;
        }
        
        // --- –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–í–£–°–¢–û–†–û–ù–ù–ï–ô –î–û–°–¢–ê–í–ö–ò ---
        function saveMessageToFriendChat(friendAt, senderName, text) {
             const allUsers = getAllUsers();
             const friend = allUsers.find(u => u.at === friendAt);
             
             if (!friend) return; 
             
             const friendFriendsList = localStorage.getItem(FRIENDS_PREFIX + friend.id);
             const friendFriends = friendFriendsList ? JSON.parse(friendFriendsList) : [];
             
             const myChatDataAsFriend = friendFriends.find(f => f.at === currentUserAt);

             if (myChatDataAsFriend) {
                 const friendChatId = myChatDataAsFriend.chatId;
                 
                 let friendMessages = getUserMessages(friend.id);
                 friendMessages[friendChatId] = friendMessages[friendChatId] || [];
                 
                 friendMessages[friendChatId].push({ 
                    sender: senderName, 
                    text: text 
                 });
                 
                 saveUserMessages(friendMessages, friend.id);
             } 
        }

        // --- CORE INIT & AUTH ---
        
        function initStorage() {
            let users = getAllUsers();
            
            // 1. –°–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            const adminExists = users.some(u => u.id === ADMIN_USER_ID);
            if (!adminExists) {
                users.push({
                    id: ADMIN_USER_ID,
                    name: "Durove",
                    at: "@durove",
                    email: "durvoe@gmail.com",
                    password: "04092012", 
                    status: "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",
                    role: "admin",
                    photo: '#000000',
                    isVerified: true
                });
                saveAllUsers(users);
            }
            
            const storedUser = localStorage.getItem(AUTH_USER_KEY);
            if (storedUser) {
                const user = JSON.parse(storedUser);
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –æ–±—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ (–≤–∞–∂–Ω–æ, –µ—Å–ª–∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –º–µ–Ω—è–ª–∞ —Ä–æ–ª—å)
                const actualUser = users.find(u => u.id === user.id);
                if (!actualUser) {
                    localStorage.removeItem(AUTH_USER_KEY);
                    showAuthView();
                    return;
                }

                currentUserId = actualUser.id;
                currentUsername = actualUser.name;
                currentUserAt = actualUser.at;
                currentUserPhoto = actualUser.photo || '';
                currentUserStatus = actualUser.status || '–û–Ω–ª–∞–π–Ω';
                currentUserRole = actualUser.role || 'user';
                currentUserIsVerified = actualUser.isVerified || false; 

                if (checkAccountStatus(actualUser)) return;

                renderFriendChats();
                showMessengerView();
                
                if (['admin', 'moderator'].includes(currentUserRole)) { 
                    document.getElementById('admin-menu-item').style.display = 'flex';
                } else {
                    document.getElementById('admin-menu-item').style.display = 'none';
                }
            } else {
                showAuthView();
            }
        }
        
        document.getElementById('auth-form').addEventListener('submit', handleAuthSubmit);

        function handleAuthSubmit(e) {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const name = document.getElementById('auth-name').value;
            const username = document.getElementById('auth-username').value;
            const errorEl = document.getElementById('error-message');
            errorEl.textContent = '';
            
            let users = getAllUsers();

            if (isLoginMode) {
                const user = users.find(u => u.email === email && u.password === password);
                
                if (user) {
                    if (checkAccountStatus(user)) return;
                    localStorage.setItem(AUTH_USER_KEY, JSON.stringify(user));
                    initStorage();
                } else {
                    errorEl.textContent = '–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π Email –∏–ª–∏ –ü–∞—Ä–æ–ª—å.';
                }
            } else {
                if (users.some(u => u.email === email)) {
                    errorEl.textContent = '–û—à–∏–±–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º Email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.';
                    return;
                }
                if (users.some(u => u.at === username)) {
                    errorEl.textContent = '–û—à–∏–±–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º Username —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.';
                    return;
                }

                const newUser = {
                    id: Date.now(),
                    name: name,
                    at: username,
                    email: email,
                    password: password,
                    status: '–û–Ω–ª–∞–π–Ω',
                    role: 'user',
                    photo: '#4da6ff', 
                    isVerified: false 
                };

                users.push(newUser);
                saveAllUsers(users);
                localStorage.setItem(AUTH_USER_KEY, JSON.stringify(newUser));
                initStorage();
            }
        }
        
        function switchAuthMode() {
            // (–õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏/–≤—Ö–æ–¥–∞)
            isLoginMode = !isLoginMode;
            const nameInput = document.getElementById('auth-name');
            const usernameInput = document.getElementById('auth-username');
            const title = document.getElementById('auth-title');
            const button = document.getElementById('auth-submit-btn');
            const link = document.querySelector('.switch-link');
            const errorEl = document.getElementById('error-message');

            errorEl.textContent = ''; 
            document.getElementById('auth-form').reset();

            if (isLoginMode) {
                nameInput.classList.add('hidden');
                usernameInput.classList.add('hidden');
                nameInput.removeAttribute('required');
                usernameInput.removeAttribute('required');

                title.textContent = '–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç';
                button.textContent = '–í–æ–π—Ç–∏';
                link.textContent = '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
            } else {
                nameInput.classList.remove('hidden');
                usernameInput.classList.remove('hidden');
                nameInput.setAttribute('required', '');
                usernameInput.setAttribute('required', '');

                title.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞';
                button.textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
                link.textContent = '–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏';
            }
        }
        
        function logout() {
            localStorage.removeItem(AUTH_USER_KEY);
            currentUserId = null;
            isLoginMode = false;
            switchAuthMode();
            showAuthView();
        }

        // --- UI & VIEWS (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
        function showAuthView() { 
            document.getElementById('auth-view').classList.remove('hidden');
            document.getElementById('messenger-view').classList.add('hidden');
        }
        
        function showMessengerView() { 
            document.getElementById('auth-view').classList.add('hidden');
            document.getElementById('messenger-view').classList.remove('hidden');
            updateProfileInputs();
            updateAvatarDisplay();
            loadChat(currentChatId);
        }

        function updateProfileInputs() {
            document.getElementById('profile-name-input').value = currentUsername;
            document.getElementById('profile-username-input').value = currentUserAt;
            document.getElementById('profile-status-input').value = currentUserStatus;
            document.getElementById('profile-photo-input').value = currentUserPhoto.startsWith('#') || currentUserPhoto.length < 5 ? currentUserPhoto : '';
        }
        
        function showProfile() {
            document.getElementById('chat-view').classList.add('hidden');
            document.getElementById('profile-view').classList.remove('hidden');
            updateProfileInputs();
        }

        function showChat(id) {
            document.getElementById('profile-view').classList.add('hidden');
            document.getElementById('chat-view').classList.remove('hidden');
            loadChat(id || currentChatId);
        }
        
        function toggleEditProfile() {
            const area = document.getElementById('edit-profile-area');
            area.classList.toggle('hidden');
        }
        
        document.getElementById('profile-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const newName = document.getElementById('profile-name-input').value;
            const newAt = document.getElementById('profile-username-input').value;
            const newStatus = document.getElementById('profile-status-input').value;
            const newPhoto = document.getElementById('profile-photo-input').value;

            let users = getAllUsers();
            const userIndex = users.findIndex(u => u.id === currentUserId);

            if (userIndex !== -1) {
                if (users.some((u, i) => i !== userIndex && u.at === newAt)) {
                    alert('–≠—Ç–æ—Ç Username —É–∂–µ –∑–∞–Ω—è—Ç!');
                    return;
                }
                
                users[userIndex].name = newName;
                users[userIndex].at = newAt;
                users[userIndex].status = newStatus;
                if (newPhoto) users[userIndex].photo = newPhoto;

                saveAllUsers(users);

                currentUsername = newName;
                currentUserAt = newAt;
                currentUserStatus = newStatus;
                if (newPhoto) currentUserPhoto = newPhoto;
                
                localStorage.setItem(AUTH_USER_KEY, JSON.stringify(users[userIndex]));

                updateAvatarDisplay();
                toggleEditProfile();
                renderFriendChats();
                alert('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!');
            }
        });
        
        // --- CHAT & FRIEND LOGIC (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
        function renderFriendChats() {
            const chatsList = document.getElementById('chats-list-container');
            chatsList.innerHTML = '';
            
            const botUser = getFriendData(BOT_CHAT_ID);
            const botItem = createChatItem(BOT_CHAT_ID, botUser, lastKnownFriendMessages[BOT_CHAT_ID] || '–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —á–∞—Ç.', currentChatId === BOT_CHAT_ID);
            chatsList.appendChild(botItem);

            const friends = getUserFriends();
            friends.forEach(friend => {
                const friendData = getFriendData(friend.chatId);
                if (friendData) {
                     const messages = getUserMessages()[friend.chatId] || [];
                     const lastMsg = messages.length > 0 ? messages[messages.length - 1].text : (friend.lastMessage || '–ù–∞—á–Ω–∏—Ç–µ –±–µ—Å–µ–¥—É...');

                     const item = createChatItem(friend.chatId, friendData, lastMsg, currentChatId === friend.chatId);
                     chatsList.appendChild(item);
                }
            });
        }
        
        function createChatItem(id, friendData, message, isActive) {
            const item = document.createElement('div');
            item.className = `chat-item ${isActive ? 'active' : ''}`;
            item.setAttribute('data-chat-id', id);
            item.setAttribute('onclick', `loadChat(${id})`);
            
            const photoOrInitial = friendData.photo || friendData.name[0];
            const name = friendData.name;
            const isVerified = friendData.isVerified;
            
            let avatarHtml = `<div class="avatar" id="avatar-${id}">${photoOrInitial}</div>`;
            
            if (photoOrInitial && photoOrInitial.startsWith('#')) {
                avatarHtml = `<div class="avatar" id="avatar-${id}" style="background-color: ${photoOrInitial};">${name[0]}</div>`;
            } else if (photoOrInitial && photoOrInitial.length <= 2 && photoOrInitial !== '#') { 
                 avatarHtml = `<div class="avatar" id="avatar-${id}" style="background-color: var(--color-brand);">${photoOrInitial}</div>`;
            }

            const verifiedBadgeHtml = isVerified ? '<i class="fas fa-check-circle verified-badge"></i>' : '';

            item.innerHTML = `
                ${avatarHtml}
                <div class="info">
                    <span class="name">${name} ${verifiedBadgeHtml}</span>
                    <p class="message" id="last-msg-${id}">${message}</p>
                </div>
            `;
            return item;
        }

        function loadChat(chatId) {
            currentChatId = chatId;
            
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-chat-id') == chatId) {
                    item.classList.add('active');
                }
            });

            const friendData = getFriendData(chatId);
            if (!friendData) return;
            
            const verifiedBadgeHtml = friendData.isVerified ? '<i class="fas fa-check-circle verified-badge"></i>' : '';
            document.getElementById('current-chat-name').innerHTML = friendData.name + verifiedBadgeHtml;
            
            document.getElementById('current-chat-status').textContent = friendData.status || (friendData.role === 'bot' ? '–û–Ω–ª–∞–π–Ω' : '–ë—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ');
            document.getElementById('current-chat-status').className = `status ${friendData.status === '–û–Ω–ª–∞–π–Ω' ? 'online' : ''}`;
            applyPhotoStyle(document.getElementById('current-chat-avatar'), friendData.photo || friendData.name[0], friendData.name);

            const messagesArea = document.getElementById('messages-area');
            messagesArea.innerHTML = '';
            
            const messages = chatId === BOT_CHAT_ID ? botChatData[BOT_CHAT_ID] : (getUserMessages()[chatId] || []);
            
            messages.forEach(msg => {
                const bubble = document.createElement('div');
                const isSent = msg.sender === currentUsername; 
                
                bubble.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
                bubble.textContent = msg.text;
                messagesArea.appendChild(bubble);
            });
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }
        
        function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text) return;

            const msgObj = { sender: currentUsername, text: text };
            
            const messagesArea = document.getElementById('messages-area');
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble sent';
            bubble.textContent = text;
            messagesArea.appendChild(bubble);
            messagesArea.scrollTop = messagesArea.scrollHeight;

            if (currentChatId === BOT_CHAT_ID) {
                botChatData[BOT_CHAT_ID].push(msgObj);
                imitateNeuroBotReply(currentChatId, text);
            } else {
                let userMessages = getUserMessages();
                userMessages[currentChatId] = userMessages[currentChatId] || [];
                userMessages[currentChatId].push(msgObj);
                saveUserMessages(userMessages);
                
                const friendData = getFriendData(currentChatId);
                if (friendData) {
                    saveMessageToFriendChat(friendData.at, currentUsername, text);
                    imitateMessageDeliveryToFriend(currentChatId, text, friendData); 
                }
            }
            
            const lastMsgEl = document.getElementById(`last-msg-${currentChatId}`);
            if (lastMsgEl) lastMsgEl.textContent = text;
            
            input.value = '';
        }

        function addReplyToChat(chatId, senderName, replyText) {
            const friendData = getFriendData(chatId);
            if (!friendData) return;
            
            const msgObj = { sender: senderName, text: replyText };
            
            let userMessages = getUserMessages();
            userMessages[chatId] = userMessages[chatId] || [];
            userMessages[chatId].push(msgObj);
            saveUserMessages(userMessages); 
            
            if (chatId !== BOT_CHAT_ID) {
                 const allUsers = getAllUsers();
                 const currentUserAsFriend = allUsers.find(u => u.at === currentUserAt); 
                 
                 if (currentUserAsFriend) {
                    const friendsFriendsList = localStorage.getItem(FRIENDS_PREFIX + friendData.id);
                    const friendsFriends = friendsFriendsList ? JSON.parse(friendsFriendsList) : [];
                    const myChatDataInFriendsList = friendsFriends.find(f => f.at === currentUserAsFriend.at); 
                    
                    if (myChatDataInFriendsList) {
                        const friendChatId = myChatDataInFriendsList.chatId;
                        let friendMessages = getUserMessages(friendData.id);
                        friendMessages[friendChatId] = friendMessages[friendChatId] || [];
                        
                        friendMessages[friendChatId].push({ 
                            sender: senderName, 
                            text: replyText 
                        });
                        saveUserMessages(friendMessages, friendData.id);
                    }
                 }
            }

            if (chatId === currentChatId) {
                const messagesArea = document.getElementById('messages-area');
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble received';
                bubble.textContent = replyText;
                messagesArea.appendChild(bubble);
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }
            
            const lastMsgEl = document.getElementById(`last-msg-${chatId}`);
            if (lastMsgEl) lastMsgEl.textContent = replyText;
        }
        
        function imitateNeuroBotReply(chatId, originalText) {
             setTimeout(() => {
                const replyText = `[–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–≤–µ—Ç] –í–∞—à –∑–∞–ø—Ä–æ—Å "${originalText.substring(0, Math.min(originalText.length, 30))}..." –ø—Ä–∏–Ω—è—Ç –∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω.`;
                addReplyToChat(chatId, 'ü§ñ –ù–µ–π—Ä–æ—Å–µ—Ç—å', replyText);
            }, 1000);
        }
        
        function imitateMessageDeliveryToFriend(chatId, originalText, friendData) {
            setTimeout(() => {
                if (friendData) {
                    const replyText = `[–û—Ç–≤–µ—Ç –æ—Ç ${friendData.name}] –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: "${originalText.substring(0, Math.min(originalText.length, 20))}..."`;
                    addReplyToChat(chatId, friendData.name, replyText);
                }
            }, 3000);
        }

        // --- SEARCH LOGIC (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
        function handleSearchKey(e) {
            const input = document.getElementById('search-friend-input');
            if (e.key === 'Enter') {
                e.preventDefault();
                showSearchModal(input.value.trim());
                input.value = '';
            }
        }

        function showSearchModal(initialSearch = '') {
            const modal = document.getElementById('search-modal');
            const input = document.getElementById('search-user-input');
            const resultDiv = document.getElementById('search-result');
            
            input.value = initialSearch.startsWith('@') ? initialSearch : '';
            resultDiv.innerHTML = '–í–≤–µ–¥–∏—Ç–µ @username –∏–ª–∏ Email –∏ –Ω–∞–∂–º–∏—Ç–µ –ü–æ–∏—Å–∫.';
            modal.classList.remove('hidden');
            input.focus();
            if (initialSearch) performSearch();
        }

        function hideSearchModal() {
            document.getElementById('search-modal').classList.add('hidden');
        }

        function performSearch() {
            const query = document.getElementById('search-user-input').value.trim().toLowerCase();
            const resultDiv = document.getElementById('search-result');
            resultDiv.innerHTML = '';

            if (query.length < 3) {
                resultDiv.innerHTML = '<p style="color:var(--color-error);">–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞.</p>';
                return;
            }

            let users = getAllUsers().filter(u => u.id !== currentUserId);
            const foundUser = users.find(u => u.at.toLowerCase() === query || u.email.toLowerCase() === query);

            if (foundUser) {
                const friends = getUserFriends();
                const isFriend = friends.some(f => f.at === foundUser.at);
                
                const verifiedHtml = foundUser.isVerified ? '<i class="fas fa-check-circle verified-badge"></i>' : '';
                
                resultDiv.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--border-light);">
                        <div style="display: flex; align-items: center;">
                            <div class="avatar" style="margin-right: 10px; background-color: ${foundUser.photo || '#4da6ff'};">${foundUser.name[0]}</div>
                            <div>
                                <div style="font-weight: bold;">${foundUser.name} ${verifiedHtml}</div>
                                <div style="color: var(--text-secondary);">${foundUser.at}</div>
                            </div>
                        </div>
                        <button onclick="addFriend('${foundUser.at}', '${foundUser.name}')" style="padding: 8px 15px; border-radius: 15px; background-color: ${isFriend ? 'var(--text-secondary)' : 'var(--color-brand)'};" ${isFriend ? 'disabled' : ''}>
                            ${isFriend ? '–£–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω' : '–î–æ–±–∞–≤–∏—Ç—å'}
                        </button>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = '<p style="color:var(--color-error);">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.</p>';
            }
        }
        
        function addFriend(friendAt, friendName) {
            let friends = getUserFriends();
            if (friends.some(f => f.at === friendAt)) return;
            
            const newChatId = Date.now();
            friends.push({ at: friendAt, chatId: newChatId, lastMessage: `–ù–∞—á–Ω–∏—Ç–µ —á–∞—Ç —Å ${friendName}` });
            saveUserFriends(friends);
            
            let userMessages = getUserMessages();
            userMessages[newChatId] = [];
            saveUserMessages(userMessages);
            
            const allUsers = getAllUsers();
            const friendData = allUsers.find(u => u.at === friendAt);

            if (friendData) {
                let friendFriends = localStorage.getItem(FRIENDS_PREFIX + friendData.id);
                friendFriends = friendFriends ? JSON.parse(friendFriends) : [];
                
                const friendNewChatId = Date.now() + 1; 

                if (!friendFriends.some(f => f.at === currentUserAt)) {
                    friendFriends.push({ 
                        at: currentUserAt, 
                        chatId: friendNewChatId, 
                        lastMessage: `–¢–µ–ø–µ—Ä—å –≤—ã –¥—Ä—É–∑—å—è —Å ${currentUsername}!`
                    });
                    localStorage.setItem(FRIENDS_PREFIX + friendData.id, JSON.stringify(friendFriends));
                    
                    let friendMessages = getUserMessages(friendData.id);
                    friendMessages[friendNewChatId] = [];
                    saveUserMessages(friendMessages, friendData.id);
                }
            }


            renderFriendChats();
            hideSearchModal();
            loadChat(newChatId);
        }

        // --- ADMIN LOGIC (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
        
        function checkAccountStatus(user) {
            const actualUser = getAllUsers().find(u => u.id === user.id) || user;
            
            if (actualUser.role === 'blocked') {
                showStatusAlert('–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', actualUser.blockReason || '–ü—Ä–∏—á–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞.');
                return true;
            }
            if (actualUser.role === 'frozen') {
                showStatusAlert('–ê–∫–∫–∞—É–Ω—Ç –∑–∞–º–æ—Ä–æ–∂–µ–Ω', `–ü—Ä–∏—á–∏–Ω–∞: ${actualUser.freezeReason || '–ù–µ —É–∫–∞–∑–∞–Ω–∞.'} –û–∂–∏–¥–∞–π—Ç–µ —Ä–∞–∑–º–æ—Ä–æ–∑–∫–∏.`);
                return true;
            }
            return false;
        }
        
        function showStatusAlert(title, reason) {
            document.getElementById('status-alert-title').textContent = title;
            document.getElementById('status-alert-reason').textContent = reason;
            document.getElementById('status-alert-modal').classList.remove('hidden');
        }

        function handleStatusAlert() {
             document.getElementById('status-alert-modal').classList.add('hidden');
             logout(); 
        }

        function showAdminPanel() {
            if (!['admin', 'moderator'].includes(currentUserRole)) return;
            document.getElementById('admin-panel-modal').classList.remove('hidden');
            document.getElementById('admin-user-result').classList.add('hidden');
            document.getElementById('admin-message').textContent = '';
        }

        function hideAdminPanel() {
            document.getElementById('admin-panel-modal').classList.add('hidden');
        }

        function adminSearchUser() {
            const searchAt = document.getElementById('admin-search-input').value.trim();
            const resultDiv = document.getElementById('admin-user-result');
            const messageEl = document.getElementById('admin-message');
            messageEl.textContent = '';
            resultDiv.classList.add('hidden');
            adminTargetUser = null;
            
            if (!searchAt.startsWith('@')) {
                messageEl.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Username, –Ω–∞—á–∏–Ω–∞—é—â–∏–π—Å—è —Å @.';
                return;
            }

            let users = getAllUsers();
            adminTargetUser = users.find(u => u.at.toLowerCase() === searchAt.toLowerCase());

            if (adminTargetUser && adminTargetUser.id !== currentUserId) {
                const verifiedHtml = adminTargetUser.isVerified ? '<i class="fas fa-check-circle verified-badge" style="font-size: 1.1em;"></i>' : '';
                document.getElementById('admin-target-name').innerHTML = `${adminTargetUser.name} ${verifiedHtml}`;
                document.getElementById('admin-target-at').textContent = adminTargetUser.at;
                document.getElementById('admin-target-status-display').textContent = `–†–æ–ª—å: ${adminTargetUser.role.toUpperCase()}`;
                applyPhotoStyle(document.getElementById('admin-target-avatar'), adminTargetUser.photo || '', adminTargetUser.name);
                
                document.getElementById('admin-role-select').value = adminTargetUser.role;
                
                resultDiv.classList.remove('hidden');
            } else if (adminTargetUser && adminTargetUser.id === currentUserId) {
                 messageEl.textContent = '–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç.';
            } else {
                 messageEl.textContent = `–ê–∫–∫–∞—É–Ω—Ç —Å Username "${searchAt}" –Ω–µ –Ω–∞–π–¥–µ–Ω.`;
            }
        }

        function adminAction(actionType) {
            if (!adminTargetUser) return;

            let users = getAllUsers();
            const userIndex = users.findIndex(u => u.id === adminTargetUser.id);
            const reason = document.getElementById('admin-reason-input').value.trim();
            const messageEl = document.getElementById('admin-message');
            messageEl.textContent = '';

            if (userIndex === -1) { messageEl.textContent = '–û—à–∏–±–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.'; return; }

            let updatedUser = { ...users[userIndex] };
            let actionText = '';
            let shouldLogOutTarget = false;

            switch (actionType) {
                case 'block':
                    if (!reason) { messageEl.textContent = '–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏!'; return; }
                    updatedUser.role = 'blocked';
                    updatedUser.blockReason = reason;
                    updatedUser.freezeReason = ''; 
                    actionText = `–ê–∫–∫–∞—É–Ω—Ç ${adminTargetUser.at} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.`;
                    shouldLogOutTarget = true;
                    break;
                case 'freeze':
                    if (!reason) { messageEl.textContent = '–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∑–∞–º–æ—Ä–æ–∑–∫–∏!'; return; }
                    updatedUser.role = 'frozen';
                    updatedUser.freezeReason = reason;
                    updatedUser.blockReason = '';
                    actionText = `–ê–∫–∫–∞—É–Ω—Ç ${adminTargetUser.at} –∑–∞–º–æ—Ä–æ–∂–µ–Ω.`;
                    shouldLogOutTarget = true;
                    break;
                case 'unfreeze':
                    updatedUser.role = 'user'; 
                    updatedUser.blockReason = '';
                    updatedUser.freezeReason = '';
                    actionText = `–ê–∫–∫–∞—É–Ω—Ç ${adminTargetUser.at} —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω/—Ä–∞–∑–º–æ—Ä–æ–∂–µ–Ω.`;
                    break;
                case 'change_role':
                    const newRole = document.getElementById('admin-role-select').value;
                    updatedUser.role = newRole;
                    updatedUser.blockReason = ''; 
                    updatedUser.freezeReason = '';
                    actionText = `–†–æ–ª—å ${adminTargetUser.at} –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ ${newRole.toUpperCase()}.`;
                    break;
                case 'reset_password':
                    updatedUser.password = DEFAULT_PASSWORD;
                    actionText = `–ü–∞—Ä–æ–ª—å ${adminTargetUser.at} —Å–±—Ä–æ—à–µ–Ω –Ω–∞ "${DEFAULT_PASSWORD}".`;
                    break;
                case 'verify':
                    updatedUser.isVerified = !updatedUser.isVerified;
                    actionText = `–°—Ç–∞—Ç—É—Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ ${adminTargetUser.at} –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${updatedUser.isVerified ? '–í–ï–†–ò–§–ò–¶–ò–†–û–í–ê–ù' : '–ù–ï –í–ï–†–ò–§–ò–¶–ò–†–û–í–ê–ù'}`;
                    break;
                case 'delete':
                    users.splice(userIndex, 1);
                    localStorage.removeItem(CHAT_MESSAGES_PREFIX + adminTargetUser.id);
                    localStorage.removeItem(FRIENDS_PREFIX + adminTargetUser.id);
                    
                    if (adminTargetUser.id === currentUserId) {
                         localStorage.removeItem(AUTH_USER_KEY);
                         alert(`–í–∞—à –∞–∫–∫–∞—É–Ω—Ç (${adminTargetUser.at}) –±—ã–ª —É–¥–∞–ª–µ–Ω. –í—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–ª–æ–≥–∏–Ω–µ–Ω—ã.`);
                         logout();
                         return;
                    }
                    
                    saveAllUsers(users);
                    messageEl.textContent = `–ê–∫–∫–∞—É–Ω—Ç ${adminTargetUser.at} –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω.`;
                    document.getElementById('admin-search-input').value = '';
                    document.getElementById('admin-user-result').classList.add('hidden');
                    return; 
            }

            users[userIndex] = updatedUser;
            saveAllUsers(users);
            messageEl.textContent = actionText;
            adminTargetUser = updatedUser; 

            if (updatedUser.id === currentUserId) {
                 localStorage.setItem(AUTH_USER_KEY, JSON.stringify(updatedUser)); 
                 
                 if (shouldLogOutTarget) {
                     alert(`–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –±—ã–ª ${updatedUser.role}. –í—ã –±—É–¥–µ—Ç–µ —Ä–∞–∑–ª–æ–≥–∏–Ω–µ–Ω—ã.`);
                     logout(); 
                     return;
                 }
                 initStorage();
            } 
            
            const verifiedHtml = updatedUser.isVerified ? '<i class="fas fa-check-circle verified-badge" style="font-size: 1.1em;"></i>' : '';
            document.getElementById('admin-target-name').innerHTML = `${updatedUser.name} ${verifiedHtml}`;
            document.getElementById('admin-target-status-display').textContent = `–†–æ–ª—å: ${updatedUser.role.toUpperCase()}`;
            document.getElementById('admin-reason-input').value = '';
            
            if (actionType === 'verify' || actionType === 'change_role' || actionType === 'unfreeze') {
                renderFriendChats(); 
                loadChat(currentChatId); 
            }
        }
        
        // --- –ù–û–í–´–ô –†–ê–ó–î–ï–õ V21: –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –î–ê–ù–ù–´–• ---
        
        function showDataSyncModal() {
            document.getElementById('sync-data-modal').classList.remove('hidden');
            document.getElementById('export-data-area').value = '';
            document.getElementById('import-data-area').value = '';
            document.getElementById('sync-message').textContent = '';
        }

        function hideDataSyncModal() {
            document.getElementById('sync-data-modal').classList.add('hidden');
        }

        function exportUserData() {
            const users = getAllUsers();
            
            // –í–∫–ª—é—á–∞–µ–º —Ç–∞–∫–∂–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ–±—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ —Å—Ç–∞—Ç—É—Å
            const authUser = localStorage.getItem(AUTH_USER_KEY);

            const dataToExport = {
                users: users,
                authUser: authUser 
            };
            
            const jsonString = JSON.stringify(dataToExport, null, 2);
            document.getElementById('export-data-area').value = jsonString;

            // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
            navigator.clipboard.writeText(jsonString).then(() => {
                document.getElementById('sync-message').textContent = '‚úÖ –ë–∞–∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ AUTH-—Ç–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.';
            }).catch(err => {
                document.getElementById('sync-message').textContent = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é.';
                console.error('Copy failed:', err);
            });
        }

        function importUserData() {
            const jsonString = document.getElementById('import-data-area').value.trim();
            const messageEl = document.getElementById('sync-message');
            messageEl.textContent = '';

            if (!jsonString) {
                messageEl.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—Å—Ç–∞–≤—å—Ç–µ JSON-–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞.';
                return;
            }

            try {
                const dataToImport = JSON.parse(jsonString);
                
                if (!dataToImport.users || !Array.isArray(dataToImport.users)) {
                    throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö. –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –º–∞—Å—Å–∏–≤ 'users'.");
                }
                
                // 1. –ò–º–ø–æ—Ä—Ç –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–∞–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                saveAllUsers(dataToImport.users);
                
                // 2. –ò–º–ø–æ—Ä—Ç –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (dataToImport.authUser) {
                    localStorage.setItem(AUTH_USER_KEY, dataToImport.authUser);
                } else {
                    localStorage.removeItem(AUTH_USER_KEY);
                }
                
                messageEl.textContent = '‚úÖ –ë–∞–∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞! –°–µ–π—á–∞—Å –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞...';
                
                setTimeout(() => {
                    window.location.reload(); 
                }, 1500); 

            } catch (e) {
                messageEl.textContent = `‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON –∏–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö. (${e.message})`;
                console.error('Import error:', e);
            }
        }

        // --- MISC (Avatars, Theme) (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
        function applyPhotoStyle(el, photo, name) {
            el.style.backgroundImage = 'none';
            el.textContent = name ? name[0] : '?';
            
            if (photo && photo.startsWith('#')) {
                el.style.backgroundColor = photo;
                el.textContent = name ? name[0] : '?';
            } else if (photo && photo.startsWith('http')) {
                el.style.backgroundImage = `url('${photo}')`;
                el.style.backgroundSize = 'cover';
                el.style.backgroundPosition = 'center';
                el.textContent = '';
            } else if (photo && photo.length <= 2) { 
                el.style.backgroundColor = 'var(--color-brand)';
                el.textContent = photo;
            }
        }
        
        function updateAvatarDisplay(photo = currentUserPhoto, name = currentUsername) {
            const elements = [
                document.getElementById('profile-avatar-display'),
                ...document.querySelectorAll('.sidebar-header .profile-icon')
            ];
            elements.forEach(el => applyPhotoStyle(el, photo, name));
        }

        function toggleTheme() {
             alert('–í —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ V21 —Ç–µ–º–∞ –∂–µ—Å—Ç–∫–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ Dark Mode.');
        }

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        document.addEventListener('DOMContentLoaded', () => {
            initStorage();
        });
        
    </script>
</body>
</html>